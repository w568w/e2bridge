# ðŸš€ enginelabs-2api (å‡¤å‡°ç‰ˆ v4.0) - æ‚¨çš„ç»ˆæž cto.new æ™ºèƒ½ä»£ç†

[![License](https://img.shields.io/badge/License-Apache_2.0-blue.svg)](https://opensource.org/licenses/Apache-2.0)
[![Version](https://img.shields.io/badge/Version-v4.0_Phoenix-brightgreen)](https://github.com/lzA6/enginelabs-2api)
[![Docker](https://img.shields.io/badge/Docker-Ready-blue?logo=docker)](https://www.docker.com/)
[![Python](https://img.shields.io/badge/Python-3.10+-blue?logo=python)](https://www.python.org/)
[![Status](https://img.shields.io/badge/Status-ç¨³å®šè¿è¡Œ-green)](https://github.com/lzA6/enginelabs-2api)

> **é¡¹ç›®æ ¸å¿ƒå“²å­¦** ðŸ’–
>
> æˆ‘ä»¬ç›¸ä¿¡ï¼ŒæŠ€æœ¯çš„é­…åŠ›ä¸ä»…åœ¨äºŽå…¶å¼ºå¤§ï¼Œæ›´åœ¨äºŽå…¶èƒ½å¤Ÿè¢«è½»æ¾åœ°åˆ†äº«ã€ç†è§£å’Œä½¿ç”¨ã€‚`enginelabs-2api` ä¸ä»…ä»…æ˜¯ä¸€å †ä»£ç ï¼Œå®ƒæ˜¯ä¸€ç§å®£è¨€ï¼š**"è®©å¼ºå¤§çš„ AI èƒ½åŠ›ï¼Œä¸æ»‘åœ°èžå…¥æ¯ä¸€ä¸ªäººçš„å·¥ä½œæµä¸­ã€‚"**
>
> å®ƒåƒä¸€ä½ä¸çŸ¥ç–²å€¦çš„ä¿¡ä½¿ï¼Œä¸ºä½ æ‰“é€š `cto.new` (EngineLabs) ä¸Ž OpenAI ç”Ÿæ€ä¹‹é—´çš„å£åž’ã€‚å®ƒé¼“åŠ±ä½ åŠ¨æ‰‹ï¼ŒåŽ»æŽ¢ç´¢ï¼ŒåŽ»åˆ›é€ ã€‚å½“ä½ è¿è¡Œå®ƒçš„é‚£ä¸€åˆ»ï¼Œä½ ä¸ä»…ä»…æ˜¯ä¸€ä¸ªä½¿ç”¨è€…ï¼Œä½ æ˜¯ä¸€ä½å¼€æ‹“è€…ï¼Œä¸€ä½å°†å…ˆè¿›ç”Ÿäº§åŠ›æŽŒæ¡åœ¨è‡ªå·±æ‰‹ä¸­çš„é­”æ³•å¸ˆã€‚æˆ‘ä»¬å¸Œæœ›è¿™ä»½æ–‡æ¡£èƒ½ç‚¹ç‡ƒä½ çš„çƒ­æƒ…ï¼Œè®©ä½ æ„Ÿå—åˆ°å¼€æºçš„å¿«ä¹å’Œåˆ›é€ çš„ä»·å€¼ã€‚**ä½ ï¼Œå°±æ˜¯æ”¹å˜çš„å¼€å§‹ï¼**

---

## âœ¨ é¡¹ç›®ç®€ä»‹

`enginelabs-2api` æ˜¯ä¸€ä¸ªé«˜æ€§èƒ½ã€è½»é‡çº§çš„ä»£ç†æœåŠ¡ã€‚å®ƒçš„æ ¸å¿ƒä½¿å‘½åªæœ‰ä¸€ä¸ªï¼š

**å°† [cto.new](https://cto.new) (åŽŸ EngineLabs) çš„åŽŸç”Ÿ APIï¼Œæ— ç¼è½¬æ¢ä¸ºä¸Ž OpenAI API å®Œå…¨å…¼å®¹çš„æ ¼å¼ã€‚**

è¿™æ„å‘³ç€ï¼Œä½ çŽ°åœ¨å¯ä»¥ï¼š

- æŠŠä½ æœ€å–œæ¬¢çš„ã€æ”¯æŒ OpenAI æŽ¥å£çš„ç¬¬ä¸‰æ–¹å®¢æˆ·ç«¯ï¼ˆæ¯”å¦‚ [NextChat](https://github.com/ChatGPTNextWeb/ChatGPT-Next-Web), [LobeChat](https://github.com/lobehub/lobe-chat) ç­‰ï¼‰ç›´æŽ¥å¯¹å‡†æœ¬é¡¹ç›®
- äº«å— `cto.new` æä¾›çš„å¼ºå¤§æ¨¡åž‹ï¼ˆå¦‚ `ClaudeSonnet4_5`, `GPT5` ç­‰ï¼‰
- å½»åº•å‘Šåˆ«æ‰‹åŠ¨åˆ·æ–°ã€èŽ·å–å’Œç®¡ç† `token` çš„ç¹çè¿‡ç¨‹ï¼æœ¬é¡¹ç›®å®žçŽ°äº† **"å…¨è‡ªåŠ¨ä»¤ç‰Œç»­æœŸ"**ï¼Œä¸€æ¬¡é…ç½®ï¼Œæ°¸ä¹…çœå¿ƒ

### ðŸŽ¯ æ ¸å¿ƒç‰¹æ€§

#### âœ… ä¼˜åŠ¿äº®ç‚¹
- **ä¸€åŠ³æ°¸é€¸**ï¼šç‹¬åˆ›çš„ `CLERK_COOKIE` è®¤è¯æœºåˆ¶ï¼Œå®žçŽ°ä»¤ç‰Œå…¨è‡ªåŠ¨ç»­æœŸï¼Œéƒ¨ç½²åŽæ— éœ€ä»»ä½•äººå·¥å¹²é¢„
- **é«˜åº¦å…¼å®¹**ï¼šå®Œç¾Žæ¨¡æ‹Ÿ OpenAI çš„ `/v1/chat/completions` å’Œ `/v1/models` æŽ¥å£ï¼Œæ”¯æŒæµå¼å“åº”
- **æžè‡´æ€§èƒ½**ï¼šåŸºäºŽ FastAPI å’Œ Uvicornï¼Œå¼‚æ­¥ I/O å¤„ç†ï¼Œå“åº”è¿…é€Ÿ
- **æ™ºèƒ½å¯¹è¯**ï¼šå†…ç½®å¯¹è¯åŽ†å²ç¼“å­˜ï¼Œèƒ½æœ‰æ•ˆåˆ©ç”¨ `cto.new` çš„ä¸Šä¸‹æ–‡è®°å¿†åŠŸèƒ½ï¼Œè®©å¯¹è¯æ›´è¿žè´¯
- **éƒ¨ç½²ç®€å•**ï¼šDocker-Compose ä¸€é”®å¯åŠ¨ï¼Œå°ç™½ä¹Ÿèƒ½åœ¨ 3 åˆ†é’Ÿå†…å®Œæˆéƒ¨ç½²
- **è½»é‡å¯é **ï¼šå ç”¨èµ„æºæžä½Žï¼Œé€‚åˆä¸ªäººæœåŠ¡å™¨æˆ– NAS é•¿æœŸè¿è¡Œ

#### âš ï¸ æ³¨æ„äº‹é¡¹
- **ä¾èµ–ä¸Šæ¸¸**ï¼šé¡¹ç›®çš„ç¨³å®šæ€§å¼ºä¾èµ–äºŽ `cto.new` å’Œ Clerk çš„å‰ç«¯æŽ¥å£
- **Cookie åˆå§‹èŽ·å–**ï¼šé¦–æ¬¡é…ç½®éœ€è¦ç”¨æˆ·ä»Žæµè§ˆå™¨æ‰‹åŠ¨èŽ·å– `CLERK_COOKIE`
- **ç¼“å­˜éžæŒä¹…**ï¼šå½“å‰çš„å¯¹è¯åŽ†å²ç¼“å­˜æ˜¯åŸºäºŽå†…å­˜çš„ï¼ŒæœåŠ¡é‡å¯åŽä¼šä¸¢å¤±

---

## ðŸ—ï¸ ç³»ç»Ÿæž¶æž„

### ðŸ”„ æ•°æ®æµæž¶æž„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    HTTP Request    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    WebSocket    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚                  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚                 â”‚
â”‚   OpenAI Client â”‚                    â”‚  enginelabs-2api â”‚                  â”‚   cto.new API   â”‚
â”‚ (NextChat, etc.)â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚   (æœ¬ä»£ç†æœåŠ¡)    â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚   (ä¸Šæ¸¸æœåŠ¡)    â”‚
â”‚                 â”‚   SSE Stream       â”‚                  â”‚   Real-time      â”‚                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   Data Stream    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                                      â”‚                                      â”‚
         â”‚                                      â”‚                                      â”‚
         â”‚                                      â”‚                                      â”‚
         â”‚                              â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”                      â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                              â”‚   Clerk Auth  â”‚                      â”‚ å¯¹è¯åŽ†å²ç®¡ç†   â”‚
         â”‚                              â”‚   (è®¤è¯æœåŠ¡)   â”‚                      â”‚ (ä¸Šä¸‹æ–‡ç¼“å­˜)   â”‚
         â”‚                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ðŸ”§ æ ¸å¿ƒå·¥ä½œæµç¨‹

1. **è®¤è¯æµç¨‹**ï¼š`CLERK_COOKIE` â†’ JWT Token è‡ªåŠ¨ç»­æœŸ
2. **è¯·æ±‚è½¬æ¢**ï¼šOpenAI æ ¼å¼ â†’ cto.new æ ¼å¼
3. **ä¸Šä¸‹æ–‡ç®¡ç†**ï¼šå¯¹è¯åŽ†å²ç¼“å­˜ä¸Žå¤ç”¨
4. **æµå¼å“åº”**ï¼šWebSocket å®žæ—¶æ•°æ® â†’ SSE æ ¼å¼è½¬æ¢

---

## ðŸ“ é¡¹ç›®ç»“æž„

```bash
enginelabs-2api/
â”œâ”€â”€ ðŸ“„ .env                    # çŽ¯å¢ƒé…ç½®æ–‡ä»¶ï¼ˆéƒ¨ç½²æ—¶åˆ›å»ºï¼‰
â”œâ”€â”€ ðŸ“„ .env.example            # çŽ¯å¢ƒé…ç½®æ¨¡æ¿
â”œâ”€â”€ ðŸ“„ Dockerfile              # Docker é•œåƒæž„å»ºé…ç½®
â”œâ”€â”€ ðŸ“„ docker-compose.yml      # Docker å®¹å™¨ç¼–æŽ’
â”œâ”€â”€ ðŸ“„ main.py                 # FastAPI åº”ç”¨ä¸»å…¥å£
â”œâ”€â”€ ðŸ“„ nginx.conf              # Nginx åå‘ä»£ç†é…ç½®
â”œâ”€â”€ ðŸ“„ requirements.txt        # Python ä¾èµ–æ¸…å•
â””â”€â”€ ðŸ“‚ app/
    â”œâ”€â”€ ðŸ“‚ core/
    â”‚   â”œâ”€â”€ ðŸ“„ __init__.py
    â”‚   â””â”€â”€ ðŸ“„ config.py       # åº”ç”¨é…ç½®ç®¡ç†
    â”œâ”€â”€ ðŸ“‚ providers/
    â”‚   â”œâ”€â”€ ðŸ“„ __init__.py
    â”‚   â”œâ”€â”€ ðŸ“„ base_provider.py     # æœåŠ¡æä¾›è€…åŸºç±»
    â”‚   â””â”€â”€ ðŸ“„ enginelabs_provider.py # EngineLabs æ ¸å¿ƒäº¤äº’é€»è¾‘
    â””â”€â”€ ðŸ“‚ utils/
        â””â”€â”€ ðŸ“„ sse_utils.py    # Server-Sent Events å·¥å…·å‡½æ•°
```

---

## ðŸ§  å·¥ä½œåŽŸç†è¯¦è§£

### ðŸŽ­ è§’è‰²æ‰®æ¼”ç‰ˆï¼ˆé€šä¿—ç†è§£ï¼‰

æƒ³è±¡ä¸€ä¸‹ï¼Œä½ æƒ³è¿›å…¥ä¸€ä¸ªåä¸º `cto.new` çš„é­”æ³•åŸŽå ¡ï¼Œä½†ä½ åªæœ‰ä¸€ä¸ªæ™®é€šçš„ OpenAI é€šè¡Œè¯ã€‚`enginelabs-2api` å°±æ˜¯ä½ çš„ä¸“å±žé­”æ³•ç¿»è¯‘å®˜å’Œå‘å¯¼ï¼š

1. **å‡ºç¤ºæ°¸ä¹…é€šè¡Œè¯**ï¼šä½ æŠŠç‰¹æ®Šçš„"æ°¸ä¹…é€šè¡Œè¯" (`CLERK_COOKIE`) äº¤ç»™å‘å¯¼
2. **è‡ªåŠ¨æ¢å–ä¸´æ—¶é—¨ç¥¨**ï¼šå‘å¯¼è‡ªåŠ¨ç”¨é€šè¡Œè¯æ¢å–æœ‰æ—¶æ•ˆçš„"ä¸´æ—¶é—¨ç¥¨" (`JWT Token`)
3. **ç¿»è¯‘ä½ çš„è¯·æ±‚**ï¼šå‘å¯¼å°† OpenAI æ ‡å‡†è¯­è¨€ç¿»è¯‘æˆåŸŽå ¡èƒ½ç†è§£çš„æ ¼å¼
4. **ä¿æŒå¯¹è¯è¿žè´¯**ï¼šå‘å¯¼ä½¿ç”¨"è®°å¿†æ°´æ™¶" (`chatHistoryId`) è®°ä½ä¹‹å‰çš„å¯¹è¯
5. **å®žæ—¶ä¼ è¯å“åº”**ï¼šé€šè¿‡"ä¼ å£°ç®¡é“" (`WebSocket`) å®žæ—¶æŽ¥æ”¶å¹¶ç¿»è¯‘æ™ºè€…çš„å›žç­”

### ðŸ”¬ æŠ€æœ¯å®žçŽ°ç‰ˆ

#### 1. è®¤è¯ä¸Žä»¤ç‰Œç®¡ç† (`_get_fresh_jwt`)
```python
# æ ¸å¿ƒæµç¨‹
cookie â†’ Clerk API â†’ JWT Token â†’ ç”¨æˆ·èº«ä»½éªŒè¯
```

- ä½¿ç”¨ `cloudscraper` ç»•è¿‡ Cloudflare ä¿æŠ¤
- è‡ªåŠ¨è°ƒç”¨ Clerk ä»¤ç‰Œåˆ·æ–°æŽ¥å£
- è¿”å›žåŒ…å«ç”¨æˆ·èº«ä»½ä¿¡æ¯çš„æ–°é²œ JWT

#### 2. ä¸Šä¸‹æ–‡ç¼“å­˜ç®¡ç† (`_get_conversation_fingerprint`)
```python
# å¯¹è¯æŒ‡çº¹ç”Ÿæˆ
history_messages â†’ JSONåºåˆ—åŒ– â†’ MD5å“ˆå¸Œ â†’ fingerprint
```

- åŸºäºŽå¯¹è¯åŽ†å²ç”Ÿæˆå”¯ä¸€æŒ‡çº¹
- å†…å­˜ç¼“å­˜ `fingerprint â†’ chatHistoryId` æ˜ å°„
- å®žçŽ°å¯¹è¯ä¸Šä¸‹æ–‡çš„æ™ºèƒ½å¤ç”¨

#### 3. è¯·æ±‚è½¬æ¢ä¸Žæµå¼å¤„ç†
```python
# å®Œæ•´å¤„ç†æµç¨‹
1. æŽ¥æ”¶ OpenAI æ ¼å¼è¯·æ±‚
2. èŽ·å–æ–°é²œ JWT ä»¤ç‰Œ
3. ç”Ÿæˆ/èŽ·å–å¯¹è¯åŽ†å² ID
4. å‘é€è§¦å‘è¯·æ±‚åˆ° cto.new
5. å»ºç«‹ WebSocket è¿žæŽ¥æŽ¥æ”¶æµå¼å“åº”
6. å®žæ—¶è½¬æ¢ä¸º SSE æ ¼å¼è¿”å›žå®¢æˆ·ç«¯
```

---

## ðŸš€ å¿«é€Ÿå¼€å§‹

### ðŸ“‹ å‰ç½®è¦æ±‚

- **Docker** & **Docker Compose**
- **Git**
- å¯è®¿é—® `cto.new` çš„ç½‘ç»œçŽ¯å¢ƒ

### âš¡ ä¸‰åˆ†é’Ÿéƒ¨ç½²æŒ‡å—

#### ç¬¬ä¸€æ­¥ï¼šèŽ·å–é¡¹ç›®ä»£ç 
```bash
git clone https://github.com/lzA6/enginelabs-2api.git
cd enginelabs-2api
```

#### ç¬¬äºŒæ­¥ï¼šé…ç½®çŽ¯å¢ƒå˜é‡
```bash
# å¤åˆ¶é…ç½®æ¨¡æ¿
cp .env.example .env

# ç¼–è¾‘é…ç½®æ–‡ä»¶
nano .env
```

é…ç½®å†…å®¹ç¤ºä¾‹ï¼š
```env
# è®¾ç½®ä½ çš„ API å¯†é’¥ï¼ˆç”¨äºŽå®¢æˆ·ç«¯è®¤è¯ï¼‰
API_MASTER_KEY=your_super_secure_api_key_here

# æœåŠ¡ç«¯å£ï¼ˆé»˜è®¤ 8089ï¼‰
NGINX_PORT=8089

# ä»Žæµè§ˆå™¨èŽ·å–çš„ Clerk Cookieï¼ˆå…³é”®é…ç½®ï¼‰
CLERK_COOKIE="__client=...; __session=...; ..."
```

#### ðŸ” å¦‚ä½•èŽ·å– CLERK_COOKIE

1. åœ¨ Chrome/Edge ä¸­ç™»å½• [cto.new](https://cto.new)
2. æŒ‰ `F12` æ‰“å¼€å¼€å‘è€…å·¥å…·
3. åˆ‡æ¢åˆ° **Network** æ ‡ç­¾é¡µ
4. åœ¨é¡µé¢ä¸­è¿›è¡Œä»»æ„æ“ä½œï¼ˆå¦‚å‘é€æ¶ˆæ¯ï¼‰
5. æ‰¾åˆ°å‘å¾€ `clerk.cto.new` æˆ– `cto.new` çš„è¯·æ±‚
6. åœ¨ **Request Headers** ä¸­æ‰¾åˆ° `cookie` å­—æ®µ
7. **å³é”®ç‚¹å‡» â†’ Copy value** å¤åˆ¶å®Œæ•´å†…å®¹

#### ç¬¬ä¸‰æ­¥ï¼šå¯åŠ¨æœåŠ¡
```bash
# ä¸€é”®éƒ¨ç½²
docker-compose up -d

# æŸ¥çœ‹æ—¥å¿—ç¡®è®¤è¿è¡ŒçŠ¶æ€
docker-compose logs -f
```

#### ç¬¬å››æ­¥ï¼šé…ç½®å®¢æˆ·ç«¯

åœ¨æ”¯æŒ OpenAI çš„å®¢æˆ·ç«¯ä¸­é…ç½®ï¼š

- **API åœ°å€**: `http://ä½ çš„æœåŠ¡å™¨IP:8089`
- **API å¯†é’¥**: åœ¨ `.env` ä¸­è®¾ç½®çš„ `API_MASTER_KEY`
- **æ¨¡åž‹**: é€‰æ‹© `ClaudeSonnet4_5` æˆ– `GPT5` ç­‰ cto.new æ”¯æŒçš„æ¨¡åž‹

---

## ðŸ› ï¸ æŠ€æœ¯æ ˆæ·±åº¦è§£æž

| æŠ€æœ¯ç»„ä»¶ | åº”ç”¨åœºæ™¯ | å¤æ‚åº¦ | ä¼˜åŠ¿ | æ›¿ä»£æ–¹æ¡ˆ |
|---------|---------|--------|------|----------|
| **FastAPI** | Web æœåŠ¡æ¡†æž¶ | â˜…â˜…â˜†â˜†â˜† | é«˜æ€§èƒ½ã€å¼‚æ­¥ã€è‡ªåŠ¨æ–‡æ¡£ | Flask, Django |
| **Docker** | å®¹å™¨åŒ–éƒ¨ç½² | â˜…â˜…â˜…â˜†â˜† | çŽ¯å¢ƒéš”ç¦»ã€ä¸€é”®éƒ¨ç½² | å®¿ä¸»æœºéƒ¨ç½² |
| **Cloudscraper** | åçˆ¬è™«ç»•è¿‡ | â˜…â˜…â˜…â˜†â˜† | æ™ºèƒ½ç»•è¿‡ Cloudflare | requests, httpx |
| **WebSockets** | å®žæ—¶é€šä¿¡ | â˜…â˜…â˜…â˜…â˜† | ä½Žå»¶è¿Ÿã€åŒå‘é€šä¿¡ | é•¿è½®è¯¢ã€SSE |
| **JWT** | èº«ä»½è®¤è¯ | â˜…â˜…â˜†â˜†â˜† | æ— çŠ¶æ€ã€æ ‡å‡†åŒ– | Session, OAuth |
| **Nginx** | åå‘ä»£ç† | â˜…â˜…â˜…â˜†â˜† | é«˜æ€§èƒ½ã€è´Ÿè½½å‡è¡¡ | Caddy, Traefik |
| **å¼‚æ­¥ç”Ÿæˆå™¨** | æµå¼å“åº” | â˜…â˜…â˜…â˜…â˜† | å†…å­˜å‹å¥½ã€å®žæ—¶æ€§ | åŒæ­¥å“åº” |

### ðŸ”§ å…³é”®æŠ€æœ¯å®žçŽ°

#### 1. å¼‚æ­¥æµå¼å¤„ç†
```python
async def stream_generator(messages, model):
    # èŽ·å–è®¤è¯ä»¤ç‰Œ
    jwt_token = await self._get_fresh_jwt()
    
    # ç®¡ç†å¯¹è¯ä¸Šä¸‹æ–‡
    chat_history_id = await self._get_conversation_fingerprint(messages)
    
    # å»ºç«‹ WebSocket è¿žæŽ¥
    async with websockets.connect(ws_url) as websocket:
        while True:
            message = await websocket.recv()
            # å®žæ—¶è½¬æ¢æ ¼å¼å¹¶è¿”å›ž
            yield format_to_sse(message)
```

#### 2. æ™ºèƒ½ç¼“å­˜æœºåˆ¶
```python
def _get_conversation_fingerprint(self, messages):
    """åŸºäºŽå¯¹è¯åŽ†å²ç”Ÿæˆå”¯ä¸€æŒ‡çº¹"""
    if len(messages) <= 1:
        return str(uuid.uuid4())
    
    history_str = json.dumps(messages[:-1], sort_keys=True)
    fingerprint = hashlib.md5(history_str.encode()).hexdigest()
    
    if fingerprint in self.conversation_cache:
        return self.conversation_cache[fingerprint]
    else:
        new_id = str(uuid.uuid4())
        self.conversation_cache[fingerprint] = new_id
        return new_id
```

---

## ðŸ“ˆ é¡¹ç›®æ¼”è¿›è·¯çº¿

### âœ… å·²å®žçŽ°åŠŸèƒ½ (v4.0 å‡¤å‡°ç‰ˆ)

- [x] **æ ¸å¿ƒä»£ç†åŠŸèƒ½**ï¼šå®Œæ•´çš„ chat/completions ä»£ç†å’Œæµå¼å“åº”
- [x] **è‡ªåŠ¨è®¤è¯ç³»ç»Ÿ**ï¼šCLERK_COOKIE â†’ JWT è‡ªåŠ¨ç»­æœŸ
- [x] **ä¸Šä¸‹æ–‡ç®¡ç†**ï¼šåŸºäºŽå†…å­˜çš„å¯¹è¯åŽ†å²ç¼“å­˜
- [x] **å®¹å™¨åŒ–éƒ¨ç½²**ï¼šDocker + Docker Compose å®Œæ•´æ”¯æŒ
- [x] **æ¨¡åž‹åˆ—è¡¨æŽ¥å£**ï¼šå…¼å®¹ OpenAI çš„ `/v1/models` ç«¯ç‚¹

### ðŸ”„ å½“å‰å±€é™æ€§ä¸Žæ”¹è¿›æ–¹å‘

#### 1. ç¼“å­˜æŒä¹…åŒ– (ä¼˜å…ˆçº§ï¼šé«˜)
**é—®é¢˜**ï¼šå†…å­˜ç¼“å­˜é‡å¯ä¸¢å¤±ï¼Œå½±å“ä¸Šä¸‹æ–‡è¿žè´¯æ€§  
**è§£å†³æ–¹æ¡ˆ**ï¼šé›†æˆ Redis å®žçŽ°æŒä¹…åŒ–å­˜å‚¨

#### 2. é”™è¯¯å¤„ç†å¢žå¼º (ä¼˜å…ˆçº§ï¼šé«˜)
**é—®é¢˜**ï¼šç½‘ç»œå¼‚å¸¸å’Œä¸Šæ¸¸æœåŠ¡å˜æ›´å¤„ç†ä¸å¤Ÿå¥å£®  
**è§£å†³æ–¹æ¡ˆ**ï¼šå®žçŽ°æŒ‡æ•°é€€é¿é‡è¯•å’Œç†”æ–­æœºåˆ¶

#### 3. åŠ¨æ€æ¨¡åž‹å‘çŽ° (ä¼˜å…ˆçº§ï¼šä¸­)
**é—®é¢˜**ï¼šæ¨¡åž‹åˆ—è¡¨ç¡¬ç¼–ç ï¼Œæ— æ³•è‡ªåŠ¨å‘çŽ°æ–°æ¨¡åž‹  
**è§£å†³æ–¹æ¡ˆ**ï¼šé€šè¿‡é€†å‘å·¥ç¨‹èŽ·å–åŠ¨æ€æ¨¡åž‹åˆ—è¡¨

### ðŸš€ æœªæ¥å‘å±•è§„åˆ’

#### çŸ­æœŸç›®æ ‡ (1-2ä¸ªæœˆ)
1. **Redis é›†æˆ**ï¼šå®žçŽ°æŒä¹…åŒ–ç¼“å­˜å­˜å‚¨
2. **å¥åº·æ£€æŸ¥**ï¼šå®Œå–„çš„æœåŠ¡ç›‘æŽ§å’Œè‡ªæ„ˆæœºåˆ¶
3. **æ—¥å¿—ç³»ç»Ÿ**ï¼šç»“æž„åŒ–æ—¥å¿—å’Œæ—¥å¿—è½®è½¬

#### ä¸­æœŸç›®æ ‡ (3-6ä¸ªæœˆ)
1. **å¤šè´¦æˆ·æ”¯æŒ**ï¼šæ”¯æŒå¤šä¸ª CLERK_COOKIE è½®æ¢ä½¿ç”¨
2. **é…ç½®ç•Œé¢**ï¼šWeb ç®¡ç†ç•Œé¢ç®€åŒ–é…ç½®
3. **æ’ä»¶ä½“ç³»**ï¼šå¯æ‰©å±•çš„æ’ä»¶æž¶æž„

#### é•¿æœŸæ„¿æ™¯
1. **å¤šäº‘æ”¯æŒ**ï¼šé€‚é…å¤šä¸ª AI æœåŠ¡å¹³å°
2. **é›†ç¾¤éƒ¨ç½²**ï¼šæ”¯æŒé«˜å¯ç”¨åˆ†å¸ƒå¼éƒ¨ç½²
3. **ç”Ÿæ€å»ºè®¾**ï¼šå»ºç«‹å®Œæ•´çš„å·¥å…·é“¾å’Œç¤¾åŒº

---

## ðŸ›¡ï¸ æ•…éšœæŽ’é™¤ä¸Žç»´æŠ¤

### ðŸ” å¸¸è§é—®é¢˜

#### Q1: æœåŠ¡å¯åŠ¨å¤±è´¥
**ç—‡çŠ¶**ï¼šDocker å®¹å™¨æ— æ³•æ­£å¸¸å¯åŠ¨  
**æŽ’æŸ¥**ï¼š
```bash
# æŸ¥çœ‹è¯¦ç»†æ—¥å¿—
docker-compose logs

# æ£€æŸ¥çŽ¯å¢ƒå˜é‡é…ç½®
cat .env | grep -v "COOKIE"
```

#### Q2: è®¤è¯å¤±è´¥
**ç—‡çŠ¶**ï¼šAPI è¿”å›ž 401 é”™è¯¯  
**è§£å†³**ï¼š
1. é‡æ–°èŽ·å– CLERK_COOKIEï¼ˆå¯èƒ½å·²è¿‡æœŸï¼‰
2. ç¡®è®¤ Cookie æ ¼å¼æ­£ç¡®ï¼ˆåŒ…å«åœ¨åŒå¼•å·ä¸­ï¼‰

#### Q3: æµå¼å“åº”ä¸­æ–­
**ç—‡çŠ¶**ï¼šå¯¹è¯ä¸­é€”æ–­å¼€è¿žæŽ¥  
**æŽ’æŸ¥**ï¼š
- æ£€æŸ¥ç½‘ç»œç¨³å®šæ€§
- æŸ¥çœ‹æœåŠ¡ç«¯æ—¥å¿—ç¡®è®¤é”™è¯¯ä¿¡æ¯

### ðŸ”„ æ—¥å¸¸ç»´æŠ¤

#### ç›‘æŽ§æœåŠ¡çŠ¶æ€
```bash
# æŸ¥çœ‹æœåŠ¡è¿è¡ŒçŠ¶æ€
docker-compose ps

# å®žæ—¶æŸ¥çœ‹æ—¥å¿—
docker-compose logs -f --tail=50
```

#### æ›´æ–°æœåŠ¡
```bash
# æ‹‰å–æœ€æ–°ä»£ç 
git pull origin main

# é‡æ–°æž„å»ºå¹¶é‡å¯æœåŠ¡
docker-compose down
docker-compose up -d --build
```

---

## ðŸ¤ è´¡çŒ®æŒ‡å—

æˆ‘ä»¬æ¬¢è¿Žå„ç§å½¢å¼çš„è´¡çŒ®ï¼æ— è®ºæ˜¯ä»£ç æ”¹è¿›ã€æ–‡æ¡£å®Œå–„ï¼Œè¿˜æ˜¯é—®é¢˜åé¦ˆï¼Œéƒ½æ˜¯å¯¹é¡¹ç›®çš„å®è´µæ”¯æŒã€‚

### è´¡çŒ®æ–¹å¼

1. **æŠ¥å‘Šé—®é¢˜**ï¼šåœ¨ GitHub Issues ä¸­åé¦ˆ bug æˆ–å»ºè®®
2. **ä»£ç è´¡çŒ®**ï¼šFork é¡¹ç›®å¹¶æäº¤ Pull Request
3. **æ–‡æ¡£æ”¹è¿›**ï¼šå¸®åŠ©å®Œå–„æ–‡æ¡£å’Œæ•™ç¨‹
4. **ç¤¾åŒºåˆ†äº«**ï¼šåˆ†äº«ä½¿ç”¨ç»éªŒå’Œæœ€ä½³å®žè·µ

### å¼€å‘çŽ¯å¢ƒæ­å»º

```bash
# å…‹éš†é¡¹ç›®
git clone https://github.com/lzA6/enginelabs-2api.git
cd enginelabs-2api

# åˆ›å»ºè™šæ‹ŸçŽ¯å¢ƒ
python -m venv venv
source venv/bin/activate  # Linux/Mac
# venv\Scripts\activate  # Windows

# å®‰è£…ä¾èµ–
pip install -r requirements.txt

# é…ç½®çŽ¯å¢ƒå˜é‡
cp .env.example .env
# ç¼–è¾‘ .env æ–‡ä»¶é…ç½®å‚æ•°

# å¯åŠ¨å¼€å‘æœåŠ¡å™¨
uvicorn main:app --reload --host 0.0.0.0 --port 8089
```

---

## ðŸ“œ å¼€æºåè®®

æœ¬é¡¹ç›®é‡‡ç”¨ **Apache License 2.0** å¼€æºåè®®ã€‚

### åè®®è¦ç‚¹

- **å…è®¸**ï¼šå•†ä¸šä½¿ç”¨ã€ä¿®æ”¹ã€åˆ†å‘ã€ä¸“åˆ©æŽˆæƒ
- **è¦æ±‚**ï¼šä¿ç•™ç‰ˆæƒå£°æ˜Žå’Œè®¸å¯å£°æ˜Ž
- **ç¦æ­¢**ï¼šä½¿ç”¨é¡¹ç›®åç§°è¿›è¡ŒèƒŒä¹¦
- **æ— æ‹…ä¿**ï¼šä½œè€…ä¸æ‰¿æ‹…ä½¿ç”¨é£Žé™©

å®Œæ•´çš„åè®®æ–‡æœ¬è¯·å‚é˜… [LICENSE](LICENSE) æ–‡ä»¶ã€‚

---

## ðŸŒŸ è‡´è°¢

æ„Ÿè°¢æ‰€æœ‰ä¸ºè¿™ä¸ªé¡¹ç›®åšå‡ºè´¡çŒ®çš„å¼€å‘è€…ã€æµ‹è¯•è€…å’Œæ–‡æ¡£ç¼–å†™è€…ã€‚ç‰¹åˆ«æ„Ÿè°¢ï¼š

- `cto.new` å›¢é˜Ÿæä¾›çš„ä¼˜ç§€ AI æœåŠ¡
- OpenAI å»ºç«‹çš„ API æ ‡å‡†ç”Ÿæ€
- å¼€æºç¤¾åŒºæä¾›çš„å„ç§ä¼˜ç§€å·¥å…·å’Œåº“

---

**æ„¿ä»£ç ä¸Žä½ åŒåœ¨ï¼Œæ„¿åˆ›é€ çš„å–œæ‚¦æ°¸è¿œä¼´éšä½ ï¼**  
**May the source be with you!**

---
